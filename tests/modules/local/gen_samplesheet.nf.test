nextflow_process {
    name "Test Process GENERATE_SAMPLESHEET"
    script "modules/local/gen_samplesheet.nf"
    process "GENERATE_SAMPLESHEET"

    test("Should generate sample sheet from S3 bucket") {
        when {
            process {
                """
                input[0] = "nao-testing"
                input[1] = "read-sizer"
                input[2] = ""
                input[3] = file("${projectDir}/scripts/generate_samplesheet.py")
                """
            }
        }

        then {
            assert process.success
            assert process.trace.tasks().size() == 1
            
            // Check file output is emitted
            assert process.out.size() == 1
            assert process.out.get(0) != null
        }
    }

    test("Should generate sample sheet with custom output directory") {
        when {
            process {
                """
                input[0] = "nao-testing"
                input[1] = "read-sizer"
                input[2] = "s3://nao-testing/read-sizer/custom"
                input[3] = file("${projectDir}/scripts/generate_samplesheet.py")
                """
            }
        }

        then {
            assert process.success
            
            // Check file output is emitted
            assert process.out.size() == 1
            assert process.out.get(0) != null
        }
    }

    test("Should fail with invalid bucket") {
        when {
            process {
                """
                input[0] = "nonexistent-bucket-name-123456789"
                input[1] = "read-sizer"
                input[2] = ""
                input[3] = file("${projectDir}/scripts/generate_samplesheet.py")
                """
            }
        }

        then {
            assert process.failed
        }
    }
}